# Particles
```
I had a bet with Gordon Kane of Michigan University that the Higgs particle wouldn't be found.
- Stephen Hawking
```

## Analyze packet
Open the given packet with WireShark.

>![sc1](https://gist.githubusercontent.com/icchyr/1842ddd0a504b4672b1e/raw/eebe3adc134dd1684bde8d880996af4a1077cf88/flag.png)

Following TCP Stream (stream 0).
```
GET /Particles/1 HTTP/1.1
User-Agent: curl/7.26.0
Host: 192.168.110.9
Accept: */*

HTTP/1.1 200 OK
Date: Fri, 09 Oct 2015 16:09:18 GMT
Server: Apache/2.4.9 (Win64) PHP/5.5.12
Last-Modified: Fri, 09 Oct 2015 15:21:21 GMT
ETag: "da0-521ad88291690"
Accept-Ranges: bytes
Content-Length: 3488

zsync: 0.6.2
Filename: Particles
MTime: Wed, 12 Aug 2015 05:35:27 +0000
Blocksize: 2048
Length: 1125888
Hash-Lengths: 2,2,4
URL: Particles
SHA-1: 9be3800b49e84e0c014852977557f21bcde2a775

..{Z.Q...X..3.=.h.p+..b....]Vny.5t.|.B..c.
.w....6bp.\........>........LdO.n..A>c..../1'............8..lu+?......(.QH..H..:b2.}.....rwKvj{&.....i,..m...5.A..1..'u7..._6..8..w.]..}!
[snip]
```

What is zsync?  
I investigated and found [this](http://zsync.moria.org.uk) page. It says that zsync is like rsync using only difference between old data and new data, and zsync needs only file server but sync server.  

The given packet contains only diff data generated by zsync, where is raw data? I searched for SHA1 hash 9be3800b49e84e0c014852977557f21bcde2a775 included first stream. And I found malware which has same hash on [virustotal report](https://www.virustotal.com/en/file/61dd8b60ac35e91771d9ed4f337cd63e0aa6d0a0c5a17bb28cac59b3c21c24a9/analysis/).  
But there is no sample. So I searched for SHA256 hash 61dd8b60ac35e91771d9ed4f337cd63e0aa6d0a0c5a17bb28cac59b3c21c24a9 again.
Then I found (a report of Payload Security)[https://www.hybrid-analysis.com/sample/61dd8b60ac35e91771d9ed4f337cd63e0aa6d0a0c5a17bb28cac59b3c21c24a9?environmentId=4].  
Downloading sample and checked hash and file size, I identified that is real file of stream 0.


Now I can replay the communication using raw data and diff packet.  First I extracted 11 stream (0 to 10) including server reply, named rep{0-10}.
And I wrote following server just sending rep{0-10} for each connections.
```python
import socket

s = socket.socket()
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(("localhost", 10080))

s.listen(2)

data = [open('rep'+str(i)).read() for i in range(11)]
print map(len, data)
i = 0

while True:
    sc, _ = s.accept()
    tmp = sc.recv(2)
    res = ""
    while tmp != "":
        res += tmp
        tmp = sc.recv(1)
        if "\x0d\x0a" in res:
            break
    res = ""
    print i
    sc.send(data[i])
    sc.close()
    i += 1
```
launching this server, I named the sample "1" (no extensions) and executed zsync 6 times.
```bash
~$ zsync http://localhost:10080/1
#################### 100.0% 0.0 kBps DONE

Rejected filename specified in http://localhost:10080/1 - prefix 1 differed from filename Particles.
Read 1. Target 100.0% complete.
downloading from http://localhost:10080/Particles:
#################### 100.0% 0.0 kBps DONE

verifying download...checksum matches OK
used 1125376 local, fetched 800
~$ zsync http://localhost:10080/1
#################### 100.0% 0.0 kBps DONE

Rejected filename specified in http://localhost:10080/1 - prefix 1 differed from filename Particles.
Read 1. Target 100.0% complete.
downloading from http://localhost:10080/Particles:
#################### 100.0% 0.0 kBps DONE

verifying download...checksum matches OK
used 1125760 local, fetched 418
~$ zsync http://localhost:10080/1
[snip]
```

after patching, I checked hash.
```bash
~$ gsha1sum 1
e8c7d65370947b40418af55bdc0f65e06b7b0c59  1
```
this hash exactly matched with final zsync reply (stream 9).
```
zsync: 0.6.2
Filename: Particles
MTime: Fri, 09 Oct 2015 13:17:03 +0000
Blocksize: 512
Length: 1125888
Hash-Lengths: 2,2,4
URL: Particles
SHA-1: e8c7d65370947b40418af55bdc0f65e06b7b0c59
```

I executed this file in sandbox, and got flag.
